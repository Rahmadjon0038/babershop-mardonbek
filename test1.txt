<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Navbatni tugatish testi</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; max-width: 900px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    input, button { padding: 8px 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .ok { color: #0a7a2f; }
    .err { color: #b00020; }
    code { background: #f3f3f3; padding: 2px 4px; }
  </style>
</head>
<body>
  <h2>Barber: Navbatni "Soch olindi" qilish</h2>

  <div class="row">
    <input id="baseUrl" value="http://localhost:309" style="min-width: 260px" />
    <input id="phone" value="+998900000001" />
    <input id="password" type="password" value="barber123" />
    <button id="loginBtn">Login</button>
  </div>

  <div class="row">
    <button id="loadBtn" disabled>Bugungi navbatlarni yuklash</button>
    <span>Token: <code id="tokenPreview">yo'q</code></span>
  </div>

  <div class="row">
    <input id="appointmentIdInput" type="number" min="1" placeholder="Navbat ID (masalan 10)" />
    <button id="completeByIdBtn" disabled>ID bo'yicha Soch olindi</button>
  </div>

  <div id="status"></div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Vaqt</th>
        <th>Holat</th>
        <th>Mijoz</th>
        <th>Amal</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <script>
    const $ = (id) => document.getElementById(id);
    let accessToken = "";

    function setStatus(text, ok = true) {
      const box = $("status");
      box.className = ok ? "ok" : "err";
      box.textContent = text;
    }

    async function api(path, options = {}) {
      const baseUrl = $("baseUrl").value.trim().replace(/\/$/, "");
      const headers = { "Content-Type": "application/json", ...(options.headers || {}) };
      if (accessToken) headers.Authorization = `Bearer ${accessToken}`;

      const res = await fetch(`${baseUrl}${path}`, { ...options, headers });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.xabar || `HTTP ${res.status}`);
      return data;
    }

    async function login() {
      try {
        const phone = $("phone").value.trim();
        const password = $("password").value;

        const data = await api("/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone, password }),
        });

        accessToken = data.kirishToken || "";
        $("tokenPreview").textContent = accessToken ? `${accessToken.slice(0, 18)}...` : "yo'q";
        $("loadBtn").disabled = !accessToken;
        $("completeByIdBtn").disabled = !accessToken;
        setStatus("Login muvaffaqiyatli.");
      } catch (err) {
        setStatus(`Login xato: ${err.message}`, false);
      }
    }

    async function loadAppointments() {
      try {
        const data = await api("/barber/appointments");
        const rows = $("rows");
        rows.innerHTML = "";

        (data.navbatlar || []).forEach((n) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${n.id}</td>
            <td>${n.vaqt || ""}</td>
            <td class="state">${n.holat || ""}</td>
            <td>${n.ism || ""} (${n.telefon || ""})</td>
            <td><button ${n.holat === "completed" ? "disabled" : ""}>Soch olindi</button></td>
          `;

          tr.querySelector("button").addEventListener("click", async () => {
            try {
              const res = await api(`/barber/appointments/${n.id}/complete`, { method: "PUT" });
              tr.querySelector(".state").textContent = "completed";
              tr.querySelector("button").disabled = true;
              setStatus(res.xabar || "Navbat tugatildi.");
            } catch (err) {
              setStatus(`Tugatishda xato: ${err.message}`, false);
            }
          });

          rows.appendChild(tr);
        });

        setStatus(`Yuklandi. Sana: ${data.sana || "bugun"}`);
      } catch (err) {
        setStatus(`Navbatlarni olishda xato: ${err.message}`, false);
      }
    }

    async function completeById() {
      try {
        const id = Number($("appointmentIdInput").value);
        if (!id) {
          setStatus("Iltimos, navbat ID kiriting.", false);
          return;
        }

        const res = await api(`/barber/appointments/${id}/complete`, { method: "PUT" });
        setStatus(res.xabar || "Navbat tugatildi.");
        await loadAppointments();
      } catch (err) {
        setStatus(`ID bo'yicha tugatishda xato: ${err.message}`, false);
      }
    }

    $("loginBtn").addEventListener("click", login);
    $("loadBtn").addEventListener("click", loadAppointments);
    $("completeByIdBtn").addEventListener("click", completeById);
  </script>
</body>
</html>
